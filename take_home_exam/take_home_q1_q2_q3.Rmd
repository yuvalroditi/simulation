---
title: '311306435'
output: pdf_document
date: '2023-07-18'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
r = getOption("repos")
r["CRAN"] = "http://cran.us.r-project.org"
options(repos = r)

install.packages("DirichletReg")
install.packages("scatterplot3d") # Install
install.packages("MASS")
install.packages("MCMCprecision")
install.packages("ggpubr")

library(gridExtra)
library(ggpubr)
library(cowplot)
require(MCMCprecision)
library(Formula)
library(DirichletReg)
library("scatterplot3d") # load
library(MASS)
```


Question 1

```{r Question 1, echo=FALSE}
objective <- function(observations, rates, alphas){
  log_likelihood <- sum(ddirichlet(observations, alphas, log = TRUE))
  log_priors <- sum(dexp(rates, log = TRUE))
  log_posterior <- log_likelihood + log_priors
  return (log_posterior)
}
  
obj_hessian <- function(alphas, n){
  k <- length(alphas)
  h <- (-n)*(diag(trigamma(alphas), nrow = k, ncol = k) + 
        matrix(-trigamma(sum(alphas)), nrow = k, ncol = k))  
  return (h)
}

grad <- function(observation, rates, alphas){
  n <- dim(observation)[1]
  log_xj <- colSums(log(observation))
  log_rates <- log(rates)
  return(log_xj - log_rates -n * (digamma(alphas)-digamma(sum(alphas))))
}

opt <- function(observations, rates, tol = 0.001, max_iter = 1000, step=0.05){
  alpha_t <- fit_dirichlet(observations)$alpha
  f_prev <- objective(observations, rates, alpha_t) 
  diff <- Inf
  for(i in 1:max_iter){
    if (diff > tol){
      n <- dim(observations)[1]
      H <- obj_hessian(alpha_t, n)   
      g <- grad(observations, rates, alpha_t)
      H_inv <- solve(H)
      alpha_t <- as.vector(alpha_t - H_inv %*% g)
      f_new <- objective(observations, rates, alpha_t)
      diff <- abs(f_new - f_prev)
      f_prev <- f_new
    } else {
      return (alpha_t)
    }
  }
}

normal_est <- function(observations, rates){
  alphas <- opt(observations, rates)
  mean <- alphas
  n <- dim(observations)[1]
  h <- obj_hessian(alphas, n)
  cov_mat <- ginv(-h)
  return(list(mean = mean, sigma = cov_mat, hess = h))
}


q1 <-function(n, observations, rates){
  estimators <- normal_est(observations, rates)
  mean <- estimators$mean
  k <- length(mean)
  cov_mat <- estimators$sigma
  #cov_mat <- matrix(unlist(estimators[2]), ncol = k, nrow=k)
  samples <- mvrnorm(n, mean, cov_mat)
  return (samples)
}
```

Question 2
```{r Question 2, echo=FALSE}
q2 <- function(n, x, delta,
                           n.initial.c = 100,
                           max.iter = 10^8
                           ){
  # Estimating the mu and Sigma for the Gaussian proposals
  k <- length(delta)
  lower <- numeric(k)
  upper <- numeric(k) + Inf
  out <- normal_est(x, delta)
  mu <- out$mean
  Sigma <- out$sigma
  P <- -out$hess
  d <- 0.5*log(det(P)) - log(2*pi)
  
  # The (log) Gaussian density
  normal.log.g <- function(alpha, mu, P, d){
    -0.5 * drop(t(alpha-mu) %*% P %*% (alpha-mu)) + d
  }

  # Producing an initial estimate of c
  al <- mvrnorm(n.initial.c,mu,Sigma)
  f <- apply(al, 1, function(al) objective(x, delta, al))
  g <- apply(al, 1, function(al) normal.log.g(al,mu,P,d))
  c.est <- initial.c <- max(f - g)

  Alpha <- matrix(NA,n,k)
  n.iter <- 0
  for(i in 1:n){
    accept <- FALSE
    while((!accept) & (n.iter < max.iter)){
      al <- mvrnorm(1,mu,Sigma)
      if (all(al > lower) & all(al < upper)){
        f <- objective(x, delta, al)
        g <- normal.log.g(al,mu,P,d)
        e <- -rexp(1)
        accept <- e <= f - g - c.est
        c.est <- max(c.est, f - g)
      }
      n.iter <- n.iter + 1
      if (n.iter %% round(max.iter/4) == 0) print (c(n.iter,i,c.est))
      if (n.iter >= max.iter)
        stop(paste("Reached max.ietr = ", max.iter,
                    ". Number of simulations = ", i, sep = ""))
    }
    Alpha[i,] <- al
  }
  c.est = c(initial.c, c.est)
  names(c.est) <- c("initial", "final")
  return(list(Alpha = Alpha,
              c.est = c.est,
              n.iter = n.iter))
}
```

Question 3
```{r k=2, echo = FALSE}
for (x_size in list(1000,2000,4000)){
  rates <- c(1,2)
  X <- rdirichlet(x_size, rates)
  q1_alphas <- q1(50, X, rates)
  q2_alphas <- q2(50, X, rates)$Alpha
  
  x_range<- range(c(q1_alphas[,1], q2_alphas[,1]))
  x_range[1] <- x_range[1] - 0.01
  x_range[2] <- x_range[2] + 0.01
  y_range<- range(c(q1_alphas[,2], q2_alphas[,2]))
  y_range[1] <- y_range[1] - 0.01
  y_range[2] <- y_range[2] + 0.01
  par(mfrow=c(1,2), bg="#FFFFC8")
  image(kde2d(q1_alphas[,1],q1_alphas[,2], n = 50),
        main= paste("Gaussian approximation - Task1\n", "X size:", x_size),
        cex.main= 1,
        xlim=x_range,
        ylim=y_range,
        )
  image(kde2d(q2_alphas[,1],q2_alphas[,2], n = 50), 
        main= paste("Rejection Method approximation - Task2\n", "X size:", x_size),
        cex.main= 1,
        xlim=x_range,
        ylim=y_range)
}
```
```{r}
rates <- c(1,3,5)
X <- rdirichlet(1000, rates)
q1_alphas <- q1(50, X, rates)
q2_alphas <- q2(50, X, rates)$Alpha
q1_df <- data.frame(q1_alphas)
q1_df$approximation <- "Guassian_Task1"
q2_df <- data.frame(q2_alphas)
q2_df$approximation <- "Rejection_Task2"
df <- rbind(q1_df, q2_df)
```

```{r k=3, echo = FALSE}
install.packages("ggplot2")
library(ggplot2)
library(ggpubr)

# Create the first ggplot
library(ggplot2)
install.packages("gridExtra")  # Install the package (only needed once)
library(gridExtra)

install.packages("plyr")
  library(plyr)

for (x_size in list(100,1000,10000)){
  rates <- c(1,3,5)
  X <- rdirichlet(x_size, rates)
  q1_alphas <- q1(50, X, rates)
  q2_alphas <- q2(50, X, rates)$Alpha
  q1_df <- data.frame(q1_alphas)
  q1_df$approximation <- "Guassian_Task1"
  q2_df <- data.frame(q2_alphas)
  q2_df$approximation <- "Rejection_Task2"
  df <- rbind(q1_df, q2_df)
  
  mu1 <- ddply(df, "approximation", summarise, grp.mean=mean(X1))
  p1 <- ggplot(df, aes(x = X1, color=approximation, fill=approximation)) +
    geom_histogram(alpha=0.3) +
    geom_density(alpha=0.1)+
    geom_vline(data=mu1, aes(xintercept=grp.mean, color=approximation), linetype="dashed") + 
     theme(aspect.ratio = 1) +
    labs(title = "Alpha1")

  mu2 <- ddply(df, "approximation", summarise, grp.mean=mean(X2))
  p2 <- ggplot(df, aes(x = X2, color=approximation, fill=approximation)) +
    geom_histogram(alpha=0.3) +
    geom_density(alpha=0.1)+
    geom_vline(data=mu2, aes(xintercept=grp.mean, color=approximation), linetype="dashed") + 
    theme(aspect.ratio = 1) +
    labs(title = "Alpha2")

  mu3 <- ddply(df, "approximation", summarise, grp.mean=mean(X3))
  p3 <- ggplot(df, aes(x = X3, color=approximation, fill=approximation)) +
    geom_histogram(alpha=0.3) +
    geom_density(alpha=0.1)+
    geom_vline(data=mu3, aes(xintercept=grp.mean, color=approximation), linetype="dashed") + 
    theme(aspect.ratio = 1) +
    labs(title = "Alpha3")
  combined <- ggarrange(p1, p2, p3, ncol=3, nrow=1, common.legend = TRUE, legend="bottom")
  print(combined)
}
```

Question 4
```{r read data, echo = FALSE}

```